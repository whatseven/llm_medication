总体需求：在main.py文件中串通整个流程，main文件位置如下：/home/ubuntu/ZJQ/llm_medication/llm_medication/main.py

1.首先是输入用户症状对话之类的信息：由rewrite_query.py模块进行症状提取和改写，此文件位置为:/home/ubuntu/ZJQ/llm_medication/llm_medication/src/model/rewrite_query.py，提取症状改写之后输出结果格式为：['腹泻', '腹痛', '肛门疼痛']

2.然后将这个症状传入milvus_search.py中的函数，在此函数中会将其向量化后在milvus中进行相似度搜索，返回top5,此文件位置为:/home/ubuntu/ZJQ/llm_medication/llm_medication/src/search/milvus_search.py, 返回的数据格式如下：
[{'oid': '5bb578da831b973a137e4e63', 'name': '肺假性淋巴瘤', 'desc': '肺假性淋巴瘤(pulmonarypseudolymphoma,PL)又称结节性淋巴组织样增生(nodularlymphoidhyperplasia)，系指肺内局部淋巴组织增生性疾病，通常呈单个结节，且限于单个肺叶内。', 'symptom': '["胸痛"]', 'similarity_score': 0.8080310821533203}, {'oid': '5bb578b6831b973a137e3efe', 'name': '肺大泡', 'desc': '肺大泡是一个病理学名词，是指由于各种原因导致肺泡腔内压力升高，肺泡壁破裂，互相融合，在肺组织形成的含气囊腔。大小可从数个毫米至数个厘米，甚者可达数十厘米。目前绝大多数的肺大泡手术均可在电视胸腔镜(VATS)下完成，2/3的患者术后症状明显改善。', 'symptom': '["胸闷", "气短", "呼吸困难", "胸闷憋气"]', 'similarity_score': 0.8046225309371948}, {'oid': '5bb578e8831b973a137e54a1', 'name': '胸内异物', 'desc': '胸内异物多见于各种胸部外伤导致的异物进入胸内，胸内异物多见于胸部穿透伤，常见的溢流在胸内的异物有金属碎片或子弹头等。急症治疗原则为清创止血，纠正休克，维持循环呼吸功能，预防感染。', 'symptom': '["呼吸困难", "休克", "胸痛"]', 'similarity_score': 0.7945315837860107}]

3.将搜索到的信息进行rerank，使用reranker.py模块，位置为：/home/ubuntu/ZJQ/llm_medication/llm_medication/src/rerank/reranker.py
此函数接收两个输入：第一步rewrite模块改写后的症状，比如['腹泻', '腹痛', '肛门疼痛']和第二步milvus搜索过后的疾病列表，例如:
test_milvus_results = [
    {
        'oid': '5bb578c3831b973a137e43b9', 
        'name': '肾胚胎瘤', 
        'desc': '肾胚胎瘤又称肾母细胞瘤或Wilm\'s瘤,是幼儿时的腹内常见肿瘤，在幼儿的各种恶性肿瘤中，本病约占1/4，最多见于3岁以下的儿童，3～5岁发病率显著降低，5岁以后则少见，成人罕见，男女发病率无明显差异，多数为一侧发病，双侧同时发病者约10%左右。', 
        'symptom': '["恶心", "腹痛", "腹胀"]', 
        'similarity_score': 0.8493446111679077
    }, 
    {
        'oid': '5bb578e8831b973a137e54c6', 
        'name': '产气杆菌肠炎', 
        'desc': '产气荚膜杆菌(Clostridiumperfringen)又名魏氏梭菌(ClostridiumWelchii),它广泛存在于自然环境中，并见于几乎所有温血动物的消化道内，属于人和动物肠道内正常菌群的成员。本菌能引起人类气性坏疽及多种动物的肠毒血症和坏死性肠炎，是近年来我国家畜"猝死症"的主要病原。由产气荚膜杆菌引起的肠炎，临床上可分为食物中毒型肠炎与坏死型肠炎两种。', 
        'symptom': '["腹痛", "腹泻"]', 
        'similarity_score': 0.8307209014892578
    }, 
    {
        'oid': '5bb578db831b973a137e4edb', 
        'name': '复发性腹股沟疝', 
        'desc': '近年来大多数学者认为，腹股沟疝术后复发率在4%～10%左右。最易复发的时间在术后6～12个月以内，腹股沟直疝术后复发是斜疝的4倍，复发疝修补术后再次复发率更高。根据复发疝的发生过程，临床可将其分为遗留疝、新发疝和真性复发疝。', 
        'symptom': '["恶心", "胀痛"]', 
        'similarity_score': 0.7988762855529785
    }
]

返回的结构格式如下：
[{'oid': '5bb578e8831b973a137e54c6', 'name': '产气杆菌肠炎', 'desc': '产气荚膜杆菌(Clostridiumperfringen)又名魏氏梭菌(ClostridiumWelchii),它广泛存在于自然环境中，并见于几乎所有温血动物的消化道内，属于人和动物肠道内正常菌群的成员。本菌能引起人类气性坏疽及多种动物的肠毒血症和坏死性肠炎，是近年来我国家畜"猝死症"的主要病原。由产气荚膜杆菌引起的肠炎，临床上可分为食物中毒型肠炎与坏死型肠炎两种。', 'symptom': '["腹痛", "腹泻"]', 'similarity_score': 0.8307209014892578, 'relevance_score': 0.6918097138404846}, {'oid': '5bb578c3831b973a137e43b9', 'name': '肾胚胎瘤', 'desc': "肾胚胎瘤又称肾母细胞瘤或Wilm's瘤,是幼儿时的腹内常见肿瘤，在幼儿的各种恶性肿瘤中，本病约占1/4，最多见于3岁以下的儿童，3～5岁发病率显著降低，5岁以后则少见，成人罕见，男女发病率无明显差异，多数为一侧发病，双侧同时发病者约10%左右。", 'symptom': '["恶心", "腹痛", "腹胀"]', 'similarity_score': 0.8493446111679077, 'relevance_score': 0.543832540512085}, {'oid': '5bb578db831b973a137e4edb', 'name': '复发性腹股沟疝', 'desc': '近年来大多数学者认为，腹股沟疝术后复发率在4%～10%左右。最易复发的时间在术后6～12个月以内，腹股沟直疝术后复发是斜疝的4倍，复发疝修补术后再次复发率更高。根据复发疝的发生过程，临床可将其分为遗留疝、新发疝和真性复发疝。', 'symptom': '["恶心", "胀痛"]', 'similarity_score': 0.7988762855529785, 'relevance_score': 0.028007520362734795}]


4.然后将会交给analyzer.py模块，来分析是否可以完成诊断，还是需要更多的信息，文件位置如下：/home/ubuntu/ZJQ/llm_medication/llm_medication/src/model/analyzer.py，此模块接收最初的输入和上面rerank后的数据，进行分析是否能通过搜索到的信息完成诊断，不能的话判断哪些疾病需要进一步搜索信息，返回结果为：分析结果: {'need_more_info': True, 'diseases': ['产气杆菌肠炎', '肾胚胎瘤']}，当不需要可以完成诊断时：{"need_more_info": bool, "diseases": []}返回False。

##重要分支
第四步之后有两种情况：当返回False时，直接将这些信息传入doctor.py文件完成诊断和输出疾病，此文件位置在:/home/ubuntu/ZJQ/llm_medication/llm_medication/src/model/doctor.py

当返回为True，说明需要更多的信息，将返回的'diseases': ['产气杆菌肠炎', '肾胚胎瘤']传给下一个模块继续进行查询

5.当analyzer.py返回{'need_more_info': True, 'diseases': ['产气杆菌肠炎', '肾胚胎瘤']}时，将'diseases': ['产气杆菌肠炎', '肾胚胎瘤']的疾病依次调用neo4j_diagnose.py,此文件位置在：/home/ubuntu/ZJQ/llm_medication/llm_medication/src/search/neo4j_diagnose.py，这个模块每次接收一个级别名称，在图数据库中搜索其他的信息，所以遍历需要搜索的疾病名称传入，得到返回的信息格式如下：
疾病名称：产气杆菌肠炎

疾病病因：食物中毒型肠炎：
本型产气荚膜杆菌是梭状芽胞杆菌属的种，革兰阳性，可形成芽胞。根据所产生的可溶性抗原可分为A、B、D、E等5型。食物中毒型肠炎大都由A型引起。本菌能产生各种外毒素，其中×毒素是一种卵磷脂酶，可水解卵磷脂，并有溶血作用。引起食物中毒型肠炎的肠毒素仅在形成芽胞时产生，本菌在自然界分布甚广，存在于正常人与动物粪便中，也可从土壤、垃圾、苍蝇、水、牛奶与食物中检出。食物媒介以各种肉类与肉制品为主。肉类污染本菌后，于加热处理时芽胞不但未被杀死，反被激活易促进发育繁殖;食物中的氧气被热驱除后，造成厌氧环境也有利于本菌的大量繁殖，含活菌量达106一107/g以上才具有危险性。肠毒素作用机制与霍乱弧菌所产生者相似，小肠粘膜并无明显病理变化。
坏死型肠炎：
C型魏氏梭菌产生的α、β毒素，是引起感染鸡肠粘膜坏死这一特征性病变的直接原因。

检查项目：粪细菌培养 胃肠道CT检查 胰蛋白酶

治疗科室：传染科

并发症：代谢性酸中毒


6.最后一步，将最后诊断所需的信息传给doctor.py完成最终诊断，此文件位置在：/home/ubuntu/ZJQ/llm_medication/llm_medication/src/model/doctor.py，此文件接收以下信息：用户原始输入， 向量库步骤rerank后的数据，第五步在图数据库中搜索到的信息
但是需要注意：在analyzer.py模块中最终会输出下列格式的数据:{'need_more_info': True, 'diseases': ['产气杆菌肠炎', '肾胚胎瘤']}，我向量库中返回的是top3，这个分析说明已经排除了一种疾病，而图数据库中只会对这两个疾病进行搜索，所以最终向量库rerank后的数据也要进行一次清洗再传给doctor，即那向量库数据库中name 字段和diseases进行对比，只有相同才能传给doctor，将没有匹配的数据删除。
最后诊断输出格式：
<final_diagnosis>
{"diseases": [产气杆菌肠炎]}
</final_diagnosis>






# 医生最终诊断提示词模板
DOCTOR_SYSTEM_PROMPT = """
<身份>
作为医疗助手，请根据以下患者对话和相关信息，预测可能的疾病。
</身份>

<相关疾病信息>
候选疾病基本信息：
{vector_results}

疾病列表：
{disease_list}

详细医学资料：
{graph_data}

诊断建议：
{diagnostic_suggestions}
</相关疾病信息>

<约束条件>
根据上述信息和约束，请提供：
预测的疾病: [必须从提供的疾病列表中选择一个最合适的]

注意：只需列出疾病名称，不需要解释理由。格式如下：

##强制要求：请将最终诊断结果放在<final_diagnosis>标签中：
<final_diagnosis>
{"diseases": ["疾病名称"]}
</final_diagnosis>
</约束条件>
"""